name: Metrics
on:
  schedule: [{cron: "0 * * * *"}]
  workflow_dispatch:
  push: {branches: ["master", "main"]}
jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      - uses: actions/checkout@v4

      # ② Установка ImageMagick + resize + base64
      - name: Prepare images
        id: imgs
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq imagemagick
          for i in 1 2 3; do
            convert ".github/images/img${i}.png" \
              -resize 160x160\> -strip "/tmp/i${i}.png"
            echo "i${i}=$(base64 -w0 /tmp/i${i}.png)" >> "$GITHUB_OUTPUT"
          done

      - uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          template: classic
          base: header, activity, community, repositories, metadata
          config_display: large
          config_octicon: yes
          config_padding: 0, 10 + 6%
          config_timezone: Europe/Minsk

          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

          plugin_languages: yes
          plugin_languages_analysis_timeout: 15
          plugin_languages_analysis_timeout_repositories: 7.5
          plugin_languages_categories: markup, programming
          plugin_languages_colors: "TypeScript:#00ffb9, JavaScript:#00d49a, HTML:#009e76, CSS:#5ec4a8, Rust:#007a5e, MDX:#d4f7ed"
          plugin_languages_limit: 6
          plugin_languages_recent_categories: markup, programming
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used
          plugin_languages_threshold: 0%

          extras_css: |
            * {
              letter-spacing: 0.015em;
              box-sizing: border-box;
            }

            h1 {
              color: #ffffff !important;
              font-weight: 900 !important;
              font-size: 1.35em !important;
              text-transform: uppercase !important;
              letter-spacing: 0.08em !important;
              margin: 0 !important;
            }

            h2, h3 {
              color: #00ffb9 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.2em !important;
              font-weight: 900 !important;
              font-size: 0.82em !important;
              border-left: 4px solid #00ffb9 !important;
              padding: 3px 0 3px 9px !important;
              margin: 0 0 10px 0 !important;
              line-height: 1.5 !important;
              background: linear-gradient(90deg, rgba(0,255,185,0.07) 0%, transparent 60%) !important;
            }

            header, .header {
              border-bottom: 3px solid #00ffb9 !important;
              padding-bottom: 12px !important;
              margin-bottom: 6px !important;
            }

            section {
              border-top: 1px solid rgba(0, 255, 185, 0.22) !important;
              padding-top: 14px !important;
              margin-top: 4px !important;
            }

            img.avatar, img[src*="avatar"], img[width="64"] {
              border-radius: 0 !important;
              border: 2px solid #009e76 !important;
              outline: 1px solid rgba(0, 255, 185, 0.35) !important;
              outline-offset: 2px !important;
            }

            progress, .progress-bar, .bar {
              border-radius: 0 !important;
            }
            .progress, div[class*="progress"] {
              border-radius: 0 !important;
              background: rgba(0, 255, 185, 0.08) !important;
            }

            strong, b {
              color: #00ffb9 !important;
              font-weight: 900 !important;
              font-variant-numeric: tabular-nums !important;
            }

            span, p, li, td {
              color: #c8ede6 !important;
            }

            .octicon {
              fill: #5ec4a8 !important;
              vertical-align: middle !important;
            }

            a {
              color: #00d49a !important;
              text-decoration: none !important;
              font-weight: 600 !important;
            }

            table {
              border-collapse: collapse !important;
              width: 100% !important;
            }
            th {
              text-transform: uppercase !important;
              letter-spacing: 0.12em !important;
              font-size: 0.62em !important;
              font-weight: 700 !important;
              color: #5ec4a8 !important;
              border-bottom: 2px solid #009e76 !important;
              padding: 4px 6px !important;
            }
            td {
              border: none !important;
              border-bottom: 1px solid rgba(0, 255, 185, 0.09) !important;
              padding: 3px 6px !important;
              vertical-align: middle !important;
            }
            tr:last-child td {
              border-bottom: none !important;
            }

            :root {
              --color-calendar-graph-day-L1-bg:     #d4f7ed;
              --color-calendar-graph-day-L2-bg:     #5ec4a8;
              --color-calendar-graph-day-L3-bg:     #00a87a;
              --color-calendar-graph-day-L4-bg:     #00ffb9;
              --color-calendar-graph-day-L1-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L2-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L3-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L4-border: rgba(0, 255, 185, 0.08);
            }

            path[fill="#9be9a8"] { fill: #d4f7ed !important; }
            path[fill="#40c463"] { fill: #5ec4a8 !important; }
            path[fill="#30a14e"] { fill: #00a87a !important; }
            path[fill="#216e39"] { fill: #00ffb9 !important; }
            rect[fill="#9be9a8"] { fill: #d4f7ed !important; }
            rect[fill="#40c463"] { fill: #5ec4a8 !important; }
            rect[fill="#30a14e"] { fill: #00a87a !important; }
            rect[fill="#216e39"] { fill: #00ffb9 !important; }

            rect.ContributionCalendar-day {
              rx: 0 !important;
              ry: 0 !important;
            }

          extras_js: |
            (function () {
              var svg = document.querySelector("svg");
              if (!svg) return;

              var vb = svg.viewBox.baseVal;
              var W  = vb.width  || +svg.getAttribute("width")  || 480;
              var H  = vb.height || +svg.getAttribute("height") || 900;
              var SZ = 120;
              var PAD = 20;

              vb.height = H + SZ + PAD * 2;

              var st = document.createElementNS("http://www.w3.org/2000/svg", "style");
              st.textContent = "\
                @keyframes fl1{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}\
                @keyframes fl2{0%,100%{transform:translateY(-4px)}50%{transform:translateY(6px)}}\
                @keyframes fl3{0%,100%{transform:translateY(2px)}50%{transform:translateY(-6px)}}\
                .fi1{animation:fl1 5s ease-in-out infinite}\
                .fi2{animation:fl2 6.4s ease-in-out infinite 1.2s}\
                .fi3{animation:fl3 4.7s ease-in-out infinite 2.5s}\
              ";
              svg.prepend(st);

              var imgs = [
                "${{ steps.imgs.outputs.i1 }}",
                "${{ steps.imgs.outputs.i2 }}",
                "${{ steps.imgs.outputs.i3 }}"
              ];
              var cls = ["fi1", "fi2", "fi3"];
              var gap = (W - 3 * SZ) / 4;
              var y   = H + PAD;

              for (var i = 0; i < 3; i++) {
                if (!imgs[i] || imgs[i].length < 20) continue;
                var g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", cls[i]);
                g.setAttribute("transform",
                  "translate(" + (gap * (i + 1) + SZ * i) + "," + y + ")");
                var im = document.createElementNS("http://www.w3.org/2000/svg", "image");
                im.setAttribute("href", "data:image/png;base64," + imgs[i]);
                im.setAttribute("width",  SZ);
                im.setAttribute("height", SZ);
                g.appendChild(im);
                svg.appendChild(g);
              }
            })();
