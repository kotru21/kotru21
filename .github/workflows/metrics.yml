name: Metrics
on:
  schedule: [{cron: "0 * * * *"}]
  workflow_dispatch:
  push: {branches: ["master", "main"]}
jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      - uses: actions/checkout@v4

      - uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          template: classic
          base: header, activity, community, repositories, metadata
          config_display: large
          config_octicon: yes
          config_padding: 0, 10 + 6%
          config_timezone: Europe/Minsk

          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

          plugin_languages: yes
          plugin_languages_analysis_timeout: 15
          plugin_languages_analysis_timeout_repositories: 7.5
          plugin_languages_categories: markup, programming
          plugin_languages_colors: "TypeScript:#00ffb9, JavaScript:#00d49a, HTML:#009e76, CSS:#5ec4a8, Rust:#007a5e, MDX:#d4f7ed"
          plugin_languages_limit: 6
          plugin_languages_recent_categories: markup, programming
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used
          plugin_languages_threshold: 0%

          extras_css: |
            * { letter-spacing: 0.015em; box-sizing: border-box; }
            h1 {
              color: #ffffff !important; font-weight: 900 !important;
              font-size: 1.35em !important; text-transform: uppercase !important;
              letter-spacing: 0.08em !important; margin: 0 !important;
            }
            h2, h3 {
              color: #00ffb9 !important; text-transform: uppercase !important;
              letter-spacing: 0.2em !important; font-weight: 900 !important;
              font-size: 0.82em !important; border-left: 4px solid #00ffb9 !important;
              padding: 3px 0 3px 9px !important; margin: 0 0 10px 0 !important;
              line-height: 1.5 !important;
              background: linear-gradient(90deg, rgba(0,255,185,0.07) 0%, transparent 60%) !important;
            }
            header, .header {
              border-bottom: 3px solid #00ffb9 !important;
              padding-bottom: 12px !important; margin-bottom: 6px !important;
            }
            section {
              border-top: 1px solid rgba(0,255,185,0.22) !important;
              padding-top: 14px !important; margin-top: 4px !important;
            }
            img.avatar, img[src*="avatar"], img[width="64"] {
              border-radius: 0 !important; border: 2px solid #009e76 !important;
              outline: 1px solid rgba(0,255,185,0.35) !important; outline-offset: 2px !important;
            }
            progress, .progress-bar, .bar { border-radius: 0 !important; }
            .progress, div[class*="progress"] {
              border-radius: 0 !important; background: rgba(0,255,185,0.08) !important;
            }
            strong, b {
              color: #00ffb9 !important; font-weight: 900 !important;
              font-variant-numeric: tabular-nums !important;
            }
            span, p, li, td { color: #c8ede6 !important; }
            .octicon { fill: #5ec4a8 !important; vertical-align: middle !important; }
            a { color: #00d49a !important; text-decoration: none !important; font-weight: 600 !important; }
            table { border-collapse: collapse !important; width: 100% !important; }
            th {
              text-transform: uppercase !important; letter-spacing: 0.12em !important;
              font-size: 0.62em !important; font-weight: 700 !important;
              color: #5ec4a8 !important; border-bottom: 2px solid #009e76 !important;
              padding: 4px 6px !important;
            }
            td {
              border: none !important;
              border-bottom: 1px solid rgba(0,255,185,0.09) !important;
              padding: 3px 6px !important; vertical-align: middle !important;
            }
            tr:last-child td { border-bottom: none !important; }
            :root {
              --color-calendar-graph-day-L1-bg: #d4f7ed;
              --color-calendar-graph-day-L2-bg: #5ec4a8;
              --color-calendar-graph-day-L3-bg: #00a87a;
              --color-calendar-graph-day-L4-bg: #00ffb9;
            }
            path[fill="#9be9a8"] { fill: #d4f7ed !important; }
            path[fill="#40c463"] { fill: #5ec4a8 !important; }
            path[fill="#30a14e"] { fill: #00a87a !important; }
            path[fill="#216e39"] { fill: #00ffb9 !important; }
            rect[fill="#9be9a8"] { fill: #d4f7ed !important; }
            rect[fill="#40c463"] { fill: #5ec4a8 !important; }
            rect[fill="#30a14e"] { fill: #00a87a !important; }
            rect[fill="#216e39"] { fill: #00ffb9 !important; }
            rect.ContributionCalendar-day { rx: 0 !important; ry: 0 !important; }

      - name: Inject images into SVG
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq imagemagick
          git pull --rebase || true

          if [ ! -f github-metrics.svg ]; then
            echo "ERROR: github-metrics.svg not found"
            exit 1
          fi

          for i in 1 2 3; do
            convert ".github/workflows/images/img${i}.png" \
              -resize "80x80>" -strip "/tmp/i${i}.png"
            echo "img${i}: $(wc -c < /tmp/i${i}.png) bytes"
          done

          python3 << 'PYEOF'
          import base64, re, sys

          SVG_FILE = "github-metrics.svg"
          SZ  = 80
          PAD = 25
          TAG_START = "<!-- IMG-INJECT-START -->"
          TAG_END   = "<!-- IMG-INJECT-END -->"

          with open(SVG_FILE, "r", encoding="utf-8") as f:
              svg = f.read()
          print(f"[1] Read {len(svg)} bytes")

          # â”€â”€ IDEMPOTENCY: remove old injection â”€â”€
          idx_s = svg.find(TAG_START)
          idx_e = svg.find(TAG_END)
          if idx_s != -1 and idx_e != -1:
              svg = svg[:idx_s] + svg[idx_e + len(TAG_END):]
              print("[2] Removed previous injection")

              # also restore viewBox/height that we changed last time
              # (metrics regenerates fresh SVG each run, so this is just safety)

          # â”€â”€ Load base64 â”€â”€
          b64 = []
          for i in range(1, 4):
              with open(f"/tmp/i{i}.png", "rb") as f:
                  b64.append(base64.b64encode(f.read()).decode("ascii"))
              print(f"[3] img{i}: {len(b64[-1])} b64 chars")

          # â”€â”€ Parse viewBox â€” keep ORIGINAL strings â”€â”€
          vb_m = re.search(r'viewBox="([^"]+)"', svg)
          if not vb_m:
              print("ERROR: no viewBox"); sys.exit(1)

          vb_raw = vb_m.group(1)            # e.g. "0 0 480 1234"
          parts  = vb_raw.split()            # ["0","0","480","1234"]
          W = float(parts[2])
          H = float(parts[3])
          print(f"[4] viewBox raw: '{vb_raw}' â†’ W={W} H={H}")

          NEW_H = H + SZ + PAD * 2

          # Replace viewBox using EXACT original string (no float conversion)
          new_vb_raw = f"{parts[0]} {parts[1]} {parts[2]} {NEW_H}"
          count = svg.count(f'viewBox="{vb_raw}"')
          print(f"[5] viewBox matches: {count}")
          svg = svg.replace(f'viewBox="{vb_raw}"', f'viewBox="{new_vb_raw}"', 1)
          print(f"[5] viewBox â†’ '{new_vb_raw}'")

          # â”€â”€ Update height= on ROOT <svg> only â”€â”€
          def fix_root_svg(m):
              tag = m.group(0)
              h = re.search(r'height="[^"]*"', tag)
              if h:
                  tag = tag[:h.start()] + f'height="{NEW_H}"' + tag[h.end():]
                  print(f"[6] Root height â†’ {NEW_H}")
              return tag

          svg = re.sub(r'<svg\b[^>]*>', fix_root_svg, svg, count=1)

          # â”€â”€ Calc positions: 3 images centered in row â”€â”€
          gap = (W - 3 * SZ) / 4
          y   = H + PAD
          xs  = [gap, gap * 2 + SZ, gap * 3 + SZ * 2]
          print(f"[7] x={xs} y={y}")

          # â”€â”€ Build SVG fragment â”€â”€
          frag = f"\n{TAG_START}\n"
          for x, data in zip(xs, b64):
              frag += (
                  f'<image x="{x}" y="{y}" '
                  f'width="{SZ}" height="{SZ}" '
                  f'href="data:image/png;base64,{data}"/>\n'
              )
          frag += f"{TAG_END}\n"

          # â”€â”€ Insert before LAST </svg> â”€â”€
          ci = svg.rfind("</svg>")
          if ci == -1:
              print("ERROR: no </svg>"); sys.exit(1)
          svg = svg[:ci] + frag + svg[ci:]

          # â”€â”€ Write â”€â”€
          with open(SVG_FILE, "w", encoding="utf-8") as f:
              f.write(svg)
          print(f"[8] Written {len(svg)} bytes âœ“")
          PYEOF

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add github-metrics.svg
          git diff --cached --quiet || git commit -m "ðŸ“Š metrics + images"
          git push
