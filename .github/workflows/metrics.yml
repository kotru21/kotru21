name: Metrics
on:
  schedule: [{cron: "0 * * * *"}]
  workflow_dispatch:
  push: {branches: ["master", "main"]}
jobs:
  github-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:

      - uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update -qq && sudo apt-get install -y -qq imagemagick

      # â”€â”€ Metrics (Ð±ÐµÐ· ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº) â”€â”€
      - uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          template: classic
          base: header, activity, community, repositories, metadata
          config_display: large
          config_octicon: yes
          config_padding: 0, 10 + 6%
          config_timezone: Europe/Minsk

          plugin_isocalendar: yes
          plugin_isocalendar_duration: full-year

          plugin_languages: yes
          plugin_languages_analysis_timeout: 15
          plugin_languages_analysis_timeout_repositories: 7.5
          plugin_languages_categories: markup, programming
          plugin_languages_colors: "TypeScript:#00ffb9, JavaScript:#00d49a, HTML:#009e76, CSS:#5ec4a8, Rust:#007a5e, MDX:#d4f7ed"
          plugin_languages_limit: 6
          plugin_languages_recent_categories: markup, programming
          plugin_languages_recent_days: 14
          plugin_languages_recent_load: 300
          plugin_languages_sections: most-used
          plugin_languages_threshold: 0%

          extras_css: |
            * {
              letter-spacing: 0.015em;
              box-sizing: border-box;
            }
            h1 {
              color: #ffffff !important;
              font-weight: 900 !important;
              font-size: 1.35em !important;
              text-transform: uppercase !important;
              letter-spacing: 0.08em !important;
              margin: 0 !important;
            }
            h2, h3 {
              color: #00ffb9 !important;
              text-transform: uppercase !important;
              letter-spacing: 0.2em !important;
              font-weight: 900 !important;
              font-size: 0.82em !important;
              border-left: 4px solid #00ffb9 !important;
              padding: 3px 0 3px 9px !important;
              margin: 0 0 10px 0 !important;
              line-height: 1.5 !important;
              background: linear-gradient(90deg, rgba(0,255,185,0.07) 0%, transparent 60%) !important;
            }
            header, .header {
              border-bottom: 3px solid #00ffb9 !important;
              padding-bottom: 12px !important;
              margin-bottom: 6px !important;
            }
            section {
              border-top: 1px solid rgba(0, 255, 185, 0.22) !important;
              padding-top: 14px !important;
              margin-top: 4px !important;
            }
            img.avatar, img[src*="avatar"], img[width="64"] {
              border-radius: 0 !important;
              border: 2px solid #009e76 !important;
              outline: 1px solid rgba(0, 255, 185, 0.35) !important;
              outline-offset: 2px !important;
            }
            progress, .progress-bar, .bar {
              border-radius: 0 !important;
            }
            .progress, div[class*="progress"] {
              border-radius: 0 !important;
              background: rgba(0, 255, 185, 0.08) !important;
            }
            strong, b {
              color: #00ffb9 !important;
              font-weight: 900 !important;
              font-variant-numeric: tabular-nums !important;
            }
            span, p, li, td {
              color: #c8ede6 !important;
            }
            .octicon {
              fill: #5ec4a8 !important;
              vertical-align: middle !important;
            }
            a {
              color: #00d49a !important;
              text-decoration: none !important;
              font-weight: 600 !important;
            }
            table {
              border-collapse: collapse !important;
              width: 100% !important;
            }
            th {
              text-transform: uppercase !important;
              letter-spacing: 0.12em !important;
              font-size: 0.62em !important;
              font-weight: 700 !important;
              color: #5ec4a8 !important;
              border-bottom: 2px solid #009e76 !important;
              padding: 4px 6px !important;
            }
            td {
              border: none !important;
              border-bottom: 1px solid rgba(0, 255, 185, 0.09) !important;
              padding: 3px 6px !important;
              vertical-align: middle !important;
            }
            tr:last-child td {
              border-bottom: none !important;
            }
            :root {
              --color-calendar-graph-day-L1-bg:     #d4f7ed;
              --color-calendar-graph-day-L2-bg:     #5ec4a8;
              --color-calendar-graph-day-L3-bg:     #00a87a;
              --color-calendar-graph-day-L4-bg:     #00ffb9;
              --color-calendar-graph-day-L1-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L2-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L3-border: rgba(0, 255, 185, 0.08);
              --color-calendar-graph-day-L4-border: rgba(0, 255, 185, 0.08);
            }
            path[fill="#9be9a8"] { fill: #d4f7ed !important; }
            path[fill="#40c463"] { fill: #5ec4a8 !important; }
            path[fill="#30a14e"] { fill: #00a87a !important; }
            path[fill="#216e39"] { fill: #00ffb9 !important; }
            rect[fill="#9be9a8"] { fill: #d4f7ed !important; }
            rect[fill="#40c463"] { fill: #5ec4a8 !important; }
            rect[fill="#30a14e"] { fill: #00a87a !important; }
            rect[fill="#216e39"] { fill: #00ffb9 !important; }
            rect.ContributionCalendar-day {
              rx: 0 !important;
              ry: 0 !important;
            }

      # â”€â”€ ÐŸÐ¾ÑÑ‚-Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°: Ð²ÑˆÐ¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸ Ð¿Ñ€ÑÐ¼Ð¾ Ð² SVG â”€â”€
      - name: Inject floating images
        run: |
          git pull --rebase

          for i in 1 2 3; do
            convert ".github/workflows/images/img${i}.png" \
              -resize "100x100>" -strip "/tmp/i${i}.png"
          done

          python3 << 'PYEOF'
          import base64, re

          with open("github-metrics.svg") as f:
              svg = f.read()

          imgs = []
          for i in range(1, 4):
              with open(f"/tmp/i{i}.png", "rb") as f:
                  imgs.append(base64.b64encode(f.read()).decode())

          m = re.search(r'viewBox="([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)"', svg)
          W, H = (float(m[3]), float(m[4])) if m else (480, 900)

          SZ, PAD = 100, 20
          newH = H + SZ + PAD * 2

          svg = re.sub(
              r'(viewBox="[\d.]+\s+[\d.]+\s+[\d.]+\s+)[\d.]+"',
              f'\\1{newH}"', svg)

          hm = re.search(r'(<svg[^>]+)height="[\d.]+"', svg)
          if hm:
              svg = re.sub(r'(<svg[^>]+)height="[\d.]+"',
                           f'\\1height="{newH}"', svg)

          gap = (W - 3 * SZ) / 4
          y = H + PAD
          cls = ["fi1", "fi2", "fi3"]

          block  = '<style>'
          block += '@keyframes fl1{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}'
          block += '@keyframes fl2{0%,100%{transform:translateY(-4px)}50%{transform:translateY(6px)}}'
          block += '@keyframes fl3{0%,100%{transform:translateY(2px)}50%{transform:translateY(-6px)}}'
          block += '.fi1{animation:fl1 5s ease-in-out infinite}'
          block += '.fi2{animation:fl2 6.4s ease-in-out infinite 1.2s}'
          block += '.fi3{animation:fl3 4.7s ease-in-out infinite 2.5s}'
          block += '</style>\n'

          for i in range(3):
              x = gap * (i + 1) + SZ * i
              block += f'<g class="{cls[i]}" transform="translate({x},{y})">'
              block += f'<image href="data:image/png;base64,{imgs[i]}" width="{SZ}" height="{SZ}"/>'
              block += '</g>\n'

          svg = svg.replace('</svg>', block + '</svg>')

          with open("github-metrics.svg", "w") as f:
              f.write(svg)
          PYEOF

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add github-metrics.svg
          git diff --cached --quiet || git commit -m "ðŸ“Š metrics + images"
          git push
